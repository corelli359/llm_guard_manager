# LLM Guard Manager V2 设计文档总览

## 📋 文档清单

本次为V2版本创建了完整的设计文档，包括：

### 1. 系统架构设计
**文件**: `V2_SYSTEM_ARCHITECTURE.md`

**内容概要**:
- V1 vs V2 对比分析
- 系统组成（USAP、门户、安全管理平台）
- 认证架构设计
- 数据架构（V1到V2的数据模型变化）
- 会话架构（Ticket + JWT双Token机制）
- 技术架构和新增组件
- 安全设计
- 性能设计
- 兼容性设计（渐进式迁移）
- 监控与运维

**核心亮点**:
- ✅ 企业级SSO架构
- ✅ 用户信息外部化
- ✅ 双Token安全机制
- ✅ 渐进式迁移策略

---

### 2. 认证流程详细设计
**文件**: `V2_AUTHENTICATION_FLOW.md`

**内容概要**:
- 完整认证链路（11个步骤）
- 门户系统登录流程
- 门户跳转到安全管理平台
- 安全管理平台SSO登录详细实现
- 用户信息同步策略
- JWT Token生成
- 后续API调用流程
- 异常处理（Ticket失败、Token失败）
- Token刷新机制
- 登出流程
- 完整时序图

**核心亮点**:
- ✅ 详细的代码实现示例
- ✅ 完整的错误处理
- ✅ 清晰的时序图
- ✅ 安全考虑周全

---

### 3. 部署架构设计
**文件**: `V2_DEPLOYMENT_ARCHITECTURE.md`

**内容概要**:
- 整体架构图
- Kubernetes资源配置
  - Namespace
  - ConfigMap
  - Secret
- 服务部署配置
  - Frontend Deployment (3副本)
  - Backend Deployment (3副本)
  - Redis StatefulSet (1副本)
- Docker镜像构建
- 部署脚本
- 监控和日志
- 高可用设计
- 网络策略
- 备份和恢复

**核心亮点**:
- ✅ 完整的K8s配置
- ✅ 生产级部署方案
- ✅ 高可用设计
- ✅ 完善的监控

---

### 4. 完整需求文档
**文件**: `V2_REQUIREMENTS.md`

**内容概要**:
- 项目概述和核心目标
- 功能需求
  - SSO单点登录
  - Token刷新
  - 登出
  - 用户信息获取
  - USAP客户端
  - 数据库变更
- 非功能需求
  - 性能需求（响应时间、并发能力）
  - 可用性需求（99.9%）
  - 安全需求
  - 可维护性需求
- 接口规范
- 数据模型
- 技术实现
- 开发任务分解（9个阶段）
- 测试计划（单元测试、集成测试、E2E测试、性能测试、安全测试）
- 风险评估
- 上线计划（灰度发布）
- 运维手册

**核心亮点**:
- ✅ 详细的任务分解
- ✅ 完整的测试计划
- ✅ 风险评估和缓解措施
- ✅ 灰度发布策略

---

## 🎯 V2版本核心变化

### 认证方式
| 维度 | V1 | V2 |
|------|----|----|
| 认证方式 | 独立认证（JWT） | SSO单点登录（Ticket + JWT） |
| 登录入口 | 直接登录 | 门户系统跳转 |
| 用户管理 | 本地完整信息 | 仅存储UserID |
| 用户信息 | 本地存储 | 从USAP实时获取 |

### 数据模型变化
```sql
-- V1: 完整用户信息
CREATE TABLE users (
    id VARCHAR(36),
    username VARCHAR(50),
    hashed_password VARCHAR(255),  -- 移除
    display_name VARCHAR(100),     -- 移除
    email VARCHAR(100),            -- 移除
    role VARCHAR(20),
    ...
);

-- V2: 仅存储UserID和权限
CREATE TABLE users (
    id VARCHAR(36),
    user_id VARCHAR(50),           -- 新增：USAP的UserID
    role VARCHAR(20),              -- 保留：本地角色
    last_login_at TIMESTAMP,       -- 新增：最后登录时间
    ...
);
```

### 认证流程
```
V1: 用户 → 登录页面 → 验证用户名密码 → 生成JWT → 访问系统

V2: 用户 → 门户系统 → USAP认证 → 获取Ticket →
    跳转到安全管理平台 → 验证Ticket → 生成JWT → 访问系统
```

---

## 📊 开发任务分解

### 阶段1: USAP Mock服务开发（1-2天）
创建Mock服务用于开发和测试

### 阶段2: 后端SSO功能开发（3-4天）
- USAP客户端
- SSO服务
- 用户缓存服务
- SSO API端点

### 阶段3: 数据库迁移（1天）
- 添加user_id字段
- 迁移现有数据
- 创建缓存表

### 阶段4: 前端SSO功能开发（2-3天）
- SSOLogin组件
- API客户端修改
- 路由配置修改

### 阶段5: Redis集成（1-2天）
- Redis客户端
- 用户信息缓存
- Token黑名单

### 阶段6: 现有功能改造（2-3天）
- 用户管理API修改
- 审计日志修改
- 权限检查修改

### 阶段7: K8s部署配置（1-2天）
- K8s配置文件
- 部署脚本
- 测试脚本

### 阶段8: 测试和验证（2-3天）
- 单元测试（覆盖率 > 80%）
- 集成测试
- E2E测试
- 性能测试

### 阶段9: 文档和培训（1-2天）
- 用户手册
- 运维手册
- API文档

**总计**: 约15-20天

---

## 🔒 安全设计

### Ticket安全
- ✅ 一次性使用
- ✅ 5分钟有效期
- ✅ 数字签名
- ✅ HTTPS传输

### JWT安全
- ✅ HS256签名
- ✅ 8小时有效期
- ✅ 黑名单机制
- ✅ Payload最小化

### API安全
- ✅ Client ID/Secret验证
- ✅ API限流
- ✅ 防暴力破解
- ✅ 审计日志

---

## 📈 性能指标

### 响应时间目标
| 接口 | 目标 |
|------|------|
| SSO登录 | < 1秒 |
| Token刷新 | < 200ms |
| 获取用户信息（缓存命中） | < 50ms |
| 获取用户信息（缓存未命中） | < 500ms |

### 并发能力
- 系统总QPS: 1000+
- SSO登录峰值: 100 QPS
- 用户信息查询峰值: 500 QPS

### 缓存命中率
- 目标: > 90%
- TTL: 1小时

---

## 🚀 上线策略

### 灰度发布
1. **第1周**: 10%用户灰度
2. **第2周**: 50%用户灰度
3. **第3周**: 100%全量发布

### 回滚条件
- 错误率 > 5%
- 响应时间 > 目标值 * 3
- 核心功能不可用
- 用户投诉 > 10次/小时

---

## ⚠️ 风险评估

### 技术风险
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| USAP接口不稳定 | 高 | 中 | 降级策略，使用缓存 |
| 性能不达标 | 中 | 低 | 充分测试和优化 |
| 数据迁移失败 | 高 | 低 | 充分测试，回滚方案 |

### 业务风险
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| 用户体验下降 | 中 | 中 | 用户测试和培训 |
| 现有功能受影响 | 高 | 低 | 充分回归测试 |
| 迁移周期过长 | 中 | 中 | 渐进式迁移 |

---

## 📝 核心接口

### 后端新增接口
```
POST /api/v1/sso/login          # SSO登录
POST /api/v1/sso/refresh        # Token刷新
POST /api/v1/sso/logout         # 登出
GET  /api/v1/sso/user-info      # 获取用户信息
POST /api/v1/sso/users/batch    # 批量获取用户
```

### USAP接口（外部）
```
POST /api/auth/validate-ticket  # 验证Ticket
GET  /api/users/{userId}        # 获取用户信息
POST /api/users/batch           # 批量获取用户
GET  /api/health                # 健康检查
```

---

## 🎨 架构图

### 系统拓扑
```
用户 → 门户系统 → USAP认证 → 安全管理平台
                              ↓
                    MySQL + Redis + K8s
```

### 认证流程
```
1. 用户访问门户
2. 门户调用USAP认证
3. USAP返回Ticket
4. 门户跳转到安全管理平台（携带Ticket）
5. 安全管理平台验证Ticket
6. 验证成功，生成JWT
7. 用户访问系统
```

---

## ✅ 下一步行动

### 审阅重点
1. **系统架构**: 是否符合企业内网环境？
2. **认证流程**: Ticket机制是否满足安全要求？
3. **数据模型**: 用户信息外部化是否合理？
4. **性能指标**: 响应时间和并发能力是否满足需求？
5. **部署方案**: K8s配置是否完善？
6. **风险评估**: 是否有遗漏的风险？

### 需要确认的问题
1. **USAP接口规范**: 实际的USAP接口是否与文档中的假设一致？
2. **门户系统对接**: 门户系统的跳转方式是否与设计一致？
3. **用户数据映射**: 现有用户的username是否就是USAP的UserID？
4. **Redis部署**: 是否需要Redis集群还是单实例即可？
5. **监控系统**: 是否已有Prometheus/Grafana等监控系统？
6. **日志系统**: 是否已有ELK等日志聚合系统？

### 建议的审阅顺序
1. 先看 `V2_SYSTEM_ARCHITECTURE.md` 了解整体架构
2. 再看 `V2_AUTHENTICATION_FLOW.md` 了解认证细节
3. 然后看 `V2_DEPLOYMENT_ARCHITECTURE.md` 了解部署方案
4. 最后看 `V2_REQUIREMENTS.md` 了解完整需求和任务分解

---

## 📚 文档状态

| 文档 | 状态 | 页数 | 字数 |
|------|------|------|------|
| V2_SYSTEM_ARCHITECTURE.md | ✅ 完成 | ~15页 | ~5000字 |
| V2_AUTHENTICATION_FLOW.md | ✅ 完成 | ~20页 | ~6000字 |
| V2_DEPLOYMENT_ARCHITECTURE.md | ✅ 完成 | ~25页 | ~7000字 |
| V2_REQUIREMENTS.md | ✅ 完成 | ~40页 | ~12000字 |
| V2_MOCK_USAP_DESIGN.md | ✅ 完成 | ~15页 | ~4000字 |
| **总计** | **✅ 完成** | **~115页** | **~34000字** |

---

**创建时间**: 2026-02-06
**文档版本**: V2.0
**审阅状态**: ⏳ 待审阅

**请您审阅以上文档，如有任何问题或需要调整的地方，请随时告知！**
