明白！在做产品迭代时，“小步快跑、控制变量”是最稳妥的策略。

既然“匹配模式”暂时只做**全文级豁免（一般模式）**，且“处置动作”保持现有逻辑不变，那么前端界面的改动将极大幅度缩减，我们只需要专注把**“豁免词（Exemptions）”**的 UI 交互和数据流转打通即可。

这是根据你的最新指示，为你重新修订的**纯净版增量需求文档**。你可以直接用这份去和前端、测试对齐。

---

# LLM Guard Manager - 增量需求文档 (PRD)：场景敏感词豁免策略升级 (修订版)

## 1. 需求概述

为解决大模型应用场景中，基于字面全匹配的场景敏感词管控（单一黑白名单）容易引发的“特定语境”误报问题（如“神经病”误杀“精神病医院”）。
本次迭代主要针对 **管理服务 (Management Service)** 中的 `场景策略配置 (Scenario Policy)` 模块进行轻量级升级，引入**“条件豁免（A|B|C逻辑）”**。

## 2. 核心概念定义

在现有的黑白名单体系之上，新增以下核心控制逻辑：

* **豁免词 (Exemptions):** 依附于特定黑名单存在的“上下文保护伞”。
* **生效规则 (全文级豁免):** 只要用户输入的长文本/请求中**包含了该豁免词**，那么其关联的黑名单词的拦截指令即被撤销。本期**不设距离限制**，采用最高效的全局匹配。

---

## 3. 功能模块升级详述

### 3.1 场景策略配置 - 列表页展示升级 (List View)

**目标模块:** `2.4 A. 场景策略配置` -> `子Tab 1.1: 敏感词管理`

在原有列表基础上，新增展示列：

* **列表展示列升级:**
* `豁免词 (Exemptions)`: **[新增]** 若该黑名单配置了豁免词，列表以 Tag 形式展示。超过 2 个时折叠展示（如显示 `+2`），鼠标 Hover 时以气泡 (Tooltip) 悬浮显示全部豁免词列表。对于“白名单”类别，该列为空。



### 3.2 场景策略配置 - 新建/编辑规则弹窗 (Form Modal)

**功能描述:** 在现有表单基础上，新增豁免词录入组件，并严格约束前端数据结构。

**表单字段与交互逻辑规范:**

| 字段名称 | UI 组件要求 | 必填 | 业务规则与联动逻辑 |
| --- | --- | --- | --- |
| **规则分类** | Radio (单选按钮) | 是 | 保持现状（【黑名单】/【白名单】）。<br>

<br>⚠️ **表单隐现联动：当选择【白名单】时，必须隐藏下方的 [豁免词] 字段。** |
| **敏感词本体** | Input (文本输入框) | 是 | 保持现状。限制 1-50 字符。禁止输入管道符 `|` 或 `,` 等分割符。 |
| **标签 (Tag Code)** | Select (下拉单选) | 否 | 保持现状。 |
| **风险等级** | Select (下拉单选) | 否 | 保持现状。 |
| **⭐ 豁免词 (Exemptions)** | **Tag Input (标签输入框)** | 否 | **[新增核心防呆]** 运营在输入框打字，**必须按 `Enter` 或 `空格` 键生成一个独立的 Tag（如“精神病医院”）**。允许点击 Tag 上的 `x` 删除。<br>

<br>⚠️ **强规则：** 绝对禁止用户手动输入 `A|B|C` 形式的长字符串，前端必须维护并提交一个纯净的 `Array<String>`。 |
| **状态** | Switch (开关) | 是 | 保持现状 (is_active)。 |

### 3.3 数据一致性与前后端交互规约 (Data Interaction)

**目标:** 确保一对多的豁免词关系在前后端流转时的一致性。

* **全量覆盖原则 (Full Replacement):**
* 前端在提交（保存）表单时，对于 `豁免词 (Exemptions)` 字段，**无需计算增量**（不需要区分哪些是新增、哪些是删除）。
* 前端直接将当前 UI 面板上的 Tag 列表作为完整的 `JSON Array` 发送给后端。
* 后端接收后，直接执行全量覆盖更新 (Overwrite)。



### 3.4 运行时热更新触发机制 (Hot Reload Trigger)

* **执行流程:**
1. 管理服务在场景关键词的增删改查及豁免词更新成功落地 TDSQL 后。
2. 提取发生变更的 `scenario_id`。
3. 通过内部调用通知“运行时围栏服务”重新拉取该场景配置，重建 AC 自动机匹配树。



---

## 4. API 接口变更规划 (API Draft Updates)

针对原文档 `5.9 场景关键词 (Scenario Keywords)` 的接口做 Payload 层的小幅扩充。

### 数据传输对象 (DTO / Schema) 变更

**提交 Payload (`POST` & `PUT` `/api/v1/keywords/scenario/{scenarioId}`)**

```json
{
  "category": 1,                      
  "keyword": "神经病",                 
  "tag_code": "insult",               // 保持原有的 tag_code 逻辑
  "exemptions": ["精神病医院", "精神病学"], // [新增] 豁免词列表 List[str]
  "risk_level": "HIGH",               
  "is_active": true
}

```

---

*(修订版文档结束)*

这样删减之后，后端的改动就非常收敛了：只要在原有的表里加一个 `exemptions` JSON 字段，接收前端传来的数组并存进去，这个迭代就能轻松落地。你看这样调整是否完美契合你目前的现状？